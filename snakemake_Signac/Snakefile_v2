"""
To run on SLURM:
snakemake -j <number of jobs> \ 
    --cluster-config=cluster.yml \
    --cluster "sbatch --mem={cluster.mem} \
    --time {cluster.time} \
    --cpus-per-task {threads} \
    -o {cluster.output} -e {cluster.error}" \
    --use-singularity \
    --keep-going

last two parameters are for singularity for R/python components
keep-going is used if anything errors out, the job still continues to run
"""

# Define the target files, usually good practice
rule all:
    input:
        rds="{output_filepath}/{data_id}_processed.RDS",
        h5ad_rna="{output_filepath}/{data_id}_RNA.h5ad",
        h5ad_atac="{output_filepath}/{data_id}_ATAC.h5ad"

rule generate_seurat_object:
    input:
        raw_data_path=config["raw_data_path"],
        gref=config["gref_path"]
    output:
        rds="{output_filepath}/{data_id}_raw.RDS"
    params:
        script_path=config["01_script_path"]
    shell:
        """
        Rscript {params.script_path} --step generate_seurat_object {input.raw_data_path} {input.gref} {output.rds} {wildcards.data_id}
        """

rule basic_QC:
    input:
        rds="{output_filepath}/{data_id}_raw.RDS"
    output:
        rds="{output_filepath}/{data_id}_QCed.RDS"
    params:
        script_path=config["01_script_path"]
    shell:
        """
        Rscript {params.script_path} --step filter_low_quality_cells {input.rds} {output.rds} {wildcards.data_id}
        """

# Continue this structure for other steps:
rule transfer_annotation:
    # ... (similar structure)

rule peak_calling:
    # ... (similar structure)

rule compute_embeddings:
    # ... (similar structure)

rule compute_gene_activity:
    # ... (similar structure)

rule export_seurat_assays:
    input:
        rds="{output_filepath}/{data_id}_gene_activity.RDS"
    output:
        h5ad_rna="{output_filepath}/{data_id}_RNA.h5ad",
        h5ad_atac="{output_filepath}/{data_id}_ATAC.h5ad"
    params:
        script_path=config["01_script_path"]
    shell:
        """
        Rscript {params.script_path} --step export_seurat_assays {input.rds} {output.h5ad_rna} {output.h5ad_atac} {wildcards.data_id}
        """