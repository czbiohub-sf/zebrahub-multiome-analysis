# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains the analysis code for **Zebrahub-Multiome**: a time-resolved single-cell multi-omic (RNA+ATAC) sequencing atlas of zebrafish development. The project analyzes single-cell multiome datasets from early zebrafish embryos across developmental timepoints to understand gene regulatory network dynamics.

## Environment Setup

The project uses **three distinct conda environments** for different analysis components:

1. **single-cell-base**: Basic scanpy, numpy, pandas environment for Figure 1 analysis
   - Environment file: `environments/single-cell-base.yml`
   - Used for: Atlas integration, QC metrics, basic single-cell analysis

2. **seacells**: Environment with SEACells for Figure 2 analysis
   - Environment file: `environments/seacells.yml`
   - Used for: RNA-ATAC correlation analysis via metacells

3. **celloracle_env**: Environment for Figures 3 and 4 analysis
   - Environment file: `environments/celloracle_env.yml`
   - Used for: Gene regulatory network (GRN) analysis and in-silico perturbation experiments

### Environment Activation Commands
```bash
# Activate based on analysis type
conda activate /hpc/user_apps/data.science/conda_envs/single-cell-base  # For Fig1
conda activate seacells                                                  # For Fig2  
conda activate celloracle_env                                           # For Fig3/4
```

## Repository Structure

### Core Analysis Directories

- **`notebooks/`**: Jupyter notebooks organized by figure, containing the main analysis workflows
- **`scripts/`**: Python/R modules with reusable code for data processing (project-specific, not general-purpose)
- **`figures/`**: Output directory for plots and visualizations generated by notebooks
- **`environments/`**: Conda environment specification files

### Key Analysis Components

1. **Figure 1 (`notebooks/Fig1_atlas_QC/`)**: 
   - Atlas integration and quality control
   - RNA/ATAC whole embryo analysis
   - Coverage plot optimization

2. **Figure 2 (`notebooks/Fig2_ATAC_RNA_correlation_metacells/`)**:
   - RNA-ATAC correlation via SEACells metacells
   - Chromatin co-accessibility dynamics

3. **Figure 3 (`notebooks/Fig3_GRN_dynamics/`)**:
   - Gene regulatory network dynamics analysis
   - Sub-GRN regulatory program extraction
   - Network comparison across timepoints

4. **Figure 4 (`notebooks/Fig4_in_silico_KO/`)**:
   - In-silico knockout simulations
   - Perturbation analysis

5. **Peak UMAP LiteMind Analysis (`scripts/litemind_peak_analysis/`)**:
   - LLM-based biological interpretation of peak clusters
   - Automated querying of biological databases (Ensembl, ZFIN, PubMed, Alliance)
   - Structured markdown reports with literature citations
   - Optional peer review and revision workflow

## LiteMind Peak Cluster Analysis

The `scripts/litemind_peak_analysis/` module provides AI-powered biological interpretation of chromatin accessibility peak clusters using large language models.

### Setup

1. **Install Dependencies:**
   ```bash
   pip install litemind==2025.7.26 openai==1.96.1 backoff requests-cache ratelimit arbol tabulate
   ```

2. **Set API Key:**
   ```bash
   # Option 1: OpenAI (default)
   export OPENAI_API_KEY="sk-your-key-here"

   # Option 2: Anthropic Claude
   export ANTHROPIC_API_KEY="sk-ant-your-key-here"
   ```

3. **Configure Data Directory (optional):**
   ```bash
   # By default, uses external litemind subrepo data
   # Override if needed:
   export LITEMIND_DATA_DIR="/path/to/your/data"
   ```

### Usage

```bash
# Analyze specific coarse clusters
python scripts/litemind_peak_analysis/main.py --coarse-clusters 0,1,2

# Analyze all coarse clusters
python scripts/litemind_peak_analysis/main.py --all-coarse

# Analyze specific fine clusters
python scripts/litemind_peak_analysis/main.py --fine-clusters 0_0,0_1

# Skip review/revision (faster, lower quality)
python scripts/litemind_peak_analysis/main.py --coarse-clusters 0 --no-review

# Use Anthropic Claude instead of OpenAI
python scripts/litemind_peak_analysis/main.py --coarse-clusters 0 --api anthropic
```

### Features

- **Automated Analysis**: Interprets pseudobulk profiles, gene associations, and motif enrichments
- **Database Integration**: Queries Ensembl, ZFIN, PubMed, Alliance, JASPAR, GO databases
- **Web Search**: Contextual literature search for validation
- **Quality Control**: Optional review and revision workflow for higher accuracy
- **Structured Output**: Generates markdown reports with:
  - Temporal dynamics and cell type specificity
  - Gene associations and motif analysis
  - Key transcription factors and regulatory programs
  - Detailed biological interpretation with citations

### Output

Results are saved in `scripts/litemind_peak_analysis/results/`:
- `coarse_cluster_analysis/` - Initial analyses
- `cluster_analysis_review/` - Quality control reviews
- `coarse_cluster_analysis_revision/` - Revised analyses

See `scripts/litemind_peak_analysis/README.md` for detailed documentation.

## Development Workflow

### Working with Notebooks

The project uses **Jupytext** for notebook management:
- Configuration in `jupytext.toml` pairs `.ipynb` files with `.py:percent` text files
- This enables better version control and collaboration on notebook content

### R Integration

Several analysis steps use R, particularly:
- `scripts/run_01_preprocess_multiome_object_signac.R`: Signac preprocessing
- `scripts/run_02_*_cicero.R`: Cicero analysis for chromatin accessibility
- `scripts/export_seurat_*.R`: Seurat object export utilities

### Key Python Modules

Located in `scripts/`, these contain domain-specific functionality:
- `color_palettes.py`: Visualization color schemes
- `pyslingshot_gpu_accel.py`: GPU-accelerated trajectory inference
- `run_*_celloracle_*.py`: CellOracle GRN analysis pipeline
- `run_*_palantir_*.py`: Palantir pseudotime analysis
- `plot_2D_vector_flows_KOs.py`: Visualization for perturbation experiments

## Data Analysis Pipeline

### Figure-Specific Workflows

1. **Atlas Construction (Fig1)**:
   - Start with single-cell-base environment
   - Run preprocessing with Signac (R)
   - Generate QC metrics and integrated visualizations

2. **RNA-ATAC Correlation (Fig2)**:
   - Switch to seacells environment
   - Compute metacells using SEACells
   - Analyze correlation dynamics across timepoints

3. **GRN Analysis (Fig3/4)**:
   - Use celloracle_env environment
   - Process chromatin accessibility with Cicero
   - Build base GRN with CellOracle
   - Compute cell-type specific networks
   - Run in-silico perturbation experiments

### Computational Considerations

- The analysis involves large-scale single-cell datasets across multiple timepoints
- GPU acceleration is available for some steps (particularly trajectory inference)
- Some notebooks generate extensive output in the `figures/` directory

## Important Notes

- Scripts are **project-specific** and designed for the Zebrahub-Multiome dataset
- Each figure analysis requires its specific conda environment
- The codebase integrates Python and R workflows for comprehensive multi-omic analysis
- Output figures are organized by analysis type in the `figures/` directory

## Citation

When using this codebase, refer to: [Zebrahub-Multiome: Uncovering Gene Regulatory Network Dynamics During Zebrafish Embryogenesis (biorxiv preprint)](https://www.biorxiv.org/content/10.1101/2024.10.18.618987v1)